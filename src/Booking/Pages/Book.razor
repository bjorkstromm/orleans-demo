@page "/book"
@implements IDisposable
@using Booking.Models
@using Booking.Grains
@using System.ComponentModel.DataAnnotations
@inject IGrainFactory GrainFactory

<PageTitle>Book</PageTitle>

<h1>Book</h1>

@if (_rooms == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <EditForm Model="@_inputModel" OnValidSubmit="@Submit">
        <DataAnnotationsValidator />

        <select @bind="_inputModel.RoomId">
            @foreach(var room in _rooms)
            {
                <option value="@room.Id">@room.Name</option>
            }
        </select>

        <input type="date" @bind="_inputModel.Date" @bind:format="yyyy-MM-dd">

        <button type="submit">Select</button>
    </EditForm>

    <hr/>

    <table class="table">
        <thead>
        <tr>
            <th>Date</th>
            <th>Start</th>
            <th>Stop</th>
            <th>Available</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var timeSlot in _timeSlots)
        {
            <tr @onclick="() => Reserve(timeSlot.Id)"
                class="clickable"
                style="@(timeSlot.Available ? "" : "background-color: red")">
                <td>@timeSlot.Date</td>
                <td>@timeSlot.Start</td>
                <td>@timeSlot.End</td>
                <td>@timeSlot.Available</td>
            </tr>
        }
        </tbody>
    </table>

    <hr/>

    @if (_reservation is not null)
    {
        if (_reservation.Success)
        {
            var expiresIn = (int)(_reservation.ExpiresOn!.Value - DateTimeOffset.UtcNow).TotalSeconds;

            <p>Reservation expires in @(expiresIn) seconds.</p>
            <button type="submit">Cancel</button>
            <button type="submit">Book</button>
        }
        else
        {
            <p style="color: red">Reservation failed.</p>
        }
    }
}

@code {

    public class InputModel
    {
        [Required]
        public string? RoomId { get; set; }

        public DateTime Date { get; set; } = DateTime.Today;
    }

    private IReadOnlyCollection<Room>? _rooms;
    private IReadOnlyCollection<TimeSlot> _timeSlots = Array.Empty<TimeSlot>();

    private InputModel _inputModel = new();
    private Reservation? _reservation = null;
    private Timer? _timer = null;

    protected override async Task OnInitializedAsync()
    {
        var catalog = GrainFactory.GetGrain<IRoomCatalogGrain>(0);
        _rooms = await catalog.GetRooms();
        _inputModel.RoomId = _rooms.FirstOrDefault()?.Id;
    }

    private async Task Submit()
    {
        var room = GrainFactory.GetGrain<IRoomGrain>(_inputModel.RoomId);

        _timeSlots = await room.GetTimeSlots(DateOnly.FromDateTime(_inputModel.Date));
    }

    private async Task Reserve(string timeSlotId)
    {
        var room = GrainFactory.GetGrain<ITimeSlotGrain>(timeSlotId);
        _reservation = await room.Reserve();

        _timer = new Timer(Tick, null, 0, 1000);
    }

    private void Tick(object? _) => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        _timer?.Dispose();
    }
}